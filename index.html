<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub AI Miner (Auto-Loop)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #000; color: #fff; text-align: center; }
        input, button { padding: 12px; margin: 8px 0; width: 90%; border-radius: 8px; border: 1px solid #555; font-size: 16px;}
        input { background: #222; color: #fff; }
        button { background: #2563eb; color: white; cursor: pointer; font-weight: bold; border: none;}
        button.stop { background: #dc2626; margin-top: 20px;}
        
        /* ç‹€æ…‹é¢æ¿ */
        .panel { background: #1a1a1a; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(255,255,255,0.1); margin-bottom: 20px;}
        
        .log { 
            background: #111; padding: 15px; margin-top: 15px; 
            border: 1px solid #333; border-radius: 5px; 
            text-align: left; font-size: 0.85rem; color: #aaa; font-family: monospace;
            height: 300px; overflow-y: auto; white-space: pre-wrap;
        }
        
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px;}
        .active { background-color: #00ff00; box-shadow: 0 0 5px #00ff00;}
        .error { background-color: #ff0000; }

        #setup-panel, #mining-panel, #overlay { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- 1. è¨­å®šå€ (ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚é¡¯ç¤º) -->
    <div id="setup-panel" class="panel">
        <h2>âš™ï¸ è¨­å®š GitHub é€£ç·š</h2>
        <p style="font-size:0.8em; color:#bbb;">è³‡æ–™å°‡å­˜å›æ‚¨çš„ Repo</p>
        <input type="text" id="repoInput" placeholder="å¸³è™Ÿ/Repo (ä¾‹: Kevin/ai-data)">
        <input type="password" id="tokenInput" placeholder="GitHub Token (ghp_...)">
        <input type="text" id="promptInput" placeholder="Prompt (ä¾‹: çµ¦æˆ‘ä¸€å€‹æ•…äº‹)" value="è«‹çµ¦æˆ‘ä¸€å€‹æ€§æ„›æ•…äº‹">
        <button onclick="saveSettings()">å„²å­˜è¨­å®š</button>
    </div>

    <!-- 2. æ›æ©Ÿé¢æ¿ -->
    <div id="mining-panel" class="panel">
        <h2>ğŸš€ AI è³‡æ–™ç¤¦å·¥ (å¾ªç’°æ¨¡å¼)</h2>
        <p>ç‹€æ…‹: <span id="status-dot" class="status-dot"></span><span id="status-text">å¾…æ©Ÿä¸­</span></p>
        <p>å·²ç”Ÿæˆç­†æ•¸: <span id="run-count" style="color: #4ade80; font-weight:bold;">0</span></p>
        <p>è·é›¢ä¸‹æ¬¡åˆ·æ–°: <span id="timer" style="color: #f87171; font-weight:bold;">--</span> ç§’</p>
        
        <div class="log" id="log-window">
            [System] ç­‰å¾…å•Ÿå‹•...
        </div>

        <button onclick="stopAndReset()" class="stop">åœæ­¢ä¸¦é‡è¨­è¨­å®š</button>
    </div>

    <!-- 3. å•Ÿå‹•é®ç½© (å¼·åˆ¶ä½¿ç”¨è€…é»æ“Šä»¥å•Ÿå‹•é˜²å¾…æ©Ÿ) -->
    <div id="overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:99;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <h2 style="margin-bottom: 20px;">âš¡ é»æ“Šå•Ÿå‹•æ›æ©Ÿ âš¡</h2>
        <p style="color:#aaa; font-size:0.9em; max-width: 80%;">è«‹ä¿æŒæ­¤åˆ†é é–‹å•Ÿï¼Œä¸è¦åˆ‡æ›åˆ°èƒŒæ™¯ã€‚<br>è¢å¹•å¯èƒ½æœƒè®Šæš—ï¼Œä½†ä¸æœƒé—œé–‰ã€‚</p>
        <button onclick="startLoop()" style="width: 200px; font-size: 1.2em; padding: 20px; background: #22c55e;">é–‹å§‹åŸ·è¡Œ</button>
    </div>

    <!-- 4. å¼·åŠ›é˜²å¾…æ©Ÿå½±ç‰‡ (NoSleep ç­–ç•¥) -->
    <!-- é€™æ˜¯ä¸€å€‹å¾®å°ã€å¾ªç’°æ’­æ”¾çš„å½±ç‰‡ï¼Œç”¨ä¾†æ¬ºé¨™æ‰‹æ©Ÿ OS èªç‚ºæ­£åœ¨çœ‹å½±ç‰‡ -->
    <video id="noSleepVideo" playsinline muted loop style="position: absolute; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; top:0; left:0;">
        <source src="https://raw.githubusercontent.com/richardschneider/nosleep.js/master/src/1sec.mp4" type="video/mp4">
    </video>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        // === è¨­å®šå€ ===
        const REFRESH_SECONDS = 120; // æ¯å¹¾ç§’è·‘ä¸€æ¬¡
        let totalRuns = 0;
        let isRunning = false;
        let wakeLock = null;

        // === åˆå§‹åŒ–æª¢æŸ¥ ===
        function init() {
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');

            if (repo && token) {
                // æœ‰è¨­å®š -> é¡¯ç¤ºé®ç½©æº–å‚™é–‹å§‹
                document.getElementById('mining-panel').style.display = 'block';
                document.getElementById('overlay').style.display = 'flex';
                log("è¨­å®šå·²è¼‰å…¥ï¼Œç­‰å¾…ä½¿ç”¨è€…å•Ÿå‹•...");
            } else {
                // ç„¡è¨­å®š -> é¡¯ç¤ºè¨­å®šé 
                document.getElementById('setup-panel').style.display = 'block';
            }
        }

        // === å„²å­˜è¨­å®š ===
        function saveSettings() {
            const repo = document.getElementById('repoInput').value.trim();
            const token = document.getElementById('tokenInput').value.trim();
            const prompt = document.getElementById('promptInput').value.trim();

            if (!repo || !token) return alert("è«‹å®Œæ•´å¡«å¯« Repo å’Œ Token");

            localStorage.setItem('gh_repo', repo);
            localStorage.setItem('gh_token', token);
            localStorage.setItem('gh_prompt', prompt);
            
            location.reload(); // è¨­å®šå®Œé‡æ•´ä¸€æ¬¡è¼‰å…¥ä»‹é¢
        }

        // === é‡ç½® ===
        function stopAndReset() {
            if(confirm("ç¢ºå®šè¦åœæ­¢ä¸¦æ¸…é™¤æ‰€æœ‰è¨­å®šå—ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        // === æ ¸å¿ƒï¼šå•Ÿå‹•æ›æ©Ÿèˆ‡é˜²å¾…æ©Ÿ ===
        async function startLoop() {
            document.getElementById('overlay').style.display = 'none';
            isRunning = true;
            updateStatus("active", "æ›æ©Ÿä¸­ - é˜²å¾…æ©Ÿå·²å•Ÿå‹•");

            // 1. å•Ÿå‹• NoSleep å½±ç‰‡ç­–ç•¥
            const video = document.getElementById('noSleepVideo');
            try {
                await video.play();
                log("[System] Video guard started.");
            } catch (err) {
                log("[Warn] Video play failed: " + err.message);
            }

            // 2. å•Ÿå‹• WakeLock API (é›™é‡ä¿éšª)
            requestWakeLock();

            // 3. é–‹å§‹åŸ·è¡Œç”Ÿæˆè¿´åœˆ
            runTask();
        }

        // === Wake Lock ç®¡ç† ===
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    log("[System] Screen Wake Lock acquired.");
                    
                    // å¦‚æœé–è¢«é‡‹æ”¾ï¼ˆä¾‹å¦‚åˆ‡æ›åˆ†é ï¼‰ï¼Œå˜—è©¦é‡æ–°ç²å–
                    wakeLock.addEventListener('release', () => {
                        log("[System] Wake Lock released.");
                        // æ³¨æ„ï¼šåˆ‡å›åˆ†é æ™‚é€šå¸¸éœ€è¦é‡æ–° requestï¼Œé€™è£¡æˆ‘å€‘ä¾è³´ visibilitychange
                    });
                }
            } catch (err) {
                console.log(err); // æŸäº›ç€è¦½å™¨ä¸æ”¯æ´ï¼Œæ²’é—œä¿‚ï¼Œæˆ‘å€‘æœ‰ Video
            }
        }

        // ç›£è½åˆ†é åˆ‡æ›ï¼Œåˆ‡å›ä¾†æ™‚é‡æ–°é–å®š
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
                // ç¢ºä¿å½±ç‰‡é‚„åœ¨è·‘
                document.getElementById('noSleepVideo').play().catch(e=>{});
            }
        });

        // === ä»»å‹™åŸ·è¡Œé‚è¼¯ (éè¿´) ===
        async function runTask() {
            if (!isRunning) return;

            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const prompt = localStorage.getItem('gh_prompt') || "è«‹çµ¦æˆ‘ä¸€å€‹æ•…äº‹";

            updateStatus("active", "æ­£åœ¨æ€è€ƒç”Ÿæˆä¸­...");
            
            try {
                // --- Step 1: Puter ç”Ÿæˆ ---
                log(`[${totalRuns + 1}] å‘¼å« Puter AI...`);
                const response = await puter.ai.chat(prompt, {model: 'x-ai/grok-4.1-fast'});
                const content = response.message.content;
                
                log(`-> ç”ŸæˆæˆåŠŸ (${content.length} å­—)ï¼Œæº–å‚™ä¸Šå‚³...`);

                // --- Step 2: GitHub ä¸Šå‚³ ---
                updateStatus("active", "æ­£åœ¨ä¸Šå‚³è‡³ GitHub...");
                
                const apiUrl = `https://api.github.com/repos/${repo}/dispatches`;
                const ghResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'save_story',
                        client_payload: {
                            prompt: prompt,
                            content: content
                        }
                    })
                });

                if (!ghResponse.ok) {
                    throw new Error(`GitHub API: ${ghResponse.status}`);
                }

                totalRuns++;
                document.getElementById('run-count').innerText = totalRuns;
                log("-> ä¸Šå‚³æˆåŠŸï¼");

            } catch (err) {
                console.error(err);
                log(`[Error] ${err.message}`);
                updateStatus("error", "ç™¼ç”ŸéŒ¯èª¤ï¼Œç¨å¾Œé‡è©¦");
            }

            // --- Step 3: å€’æ•¸è¨ˆæ™‚ä¸¦é‡è·‘ ---
            // ä¸ä½¿ç”¨ reloadï¼Œè€Œæ˜¯ä½¿ç”¨ setTimeout å‘¼å«è‡ªå·±
            startCountdown(REFRESH_SECONDS);
        }

        // === å€’æ•¸è¨ˆæ™‚å™¨ ===
        function startCountdown(seconds) {
            let left = seconds;
            const timerDisplay = document.getElementById('timer');
            updateStatus("active", "å†·å»ä¼‘æ¯ä¸­...");

            const interval = setInterval(() => {
                left--;
                timerDisplay.innerText = left;
                
                if (left <= 0) {
                    clearInterval(interval);
                    // æ™‚é–“åˆ°ï¼Œå†æ¬¡åŸ·è¡Œä»»å‹™
                    runTask();
                }
            }, 1000);
        }

        // === å·¥å…·å‡½å¼ ===
        function log(msg) {
            const box = document.getElementById('log-window');
            const time = new Date().toLocaleTimeString();
            box.innerText += `[${time}] ${msg}\n`;
            box.scrollTop = box.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        }

        function updateStatus(type, text) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            
            dot.className = "status-dot " + type;
            txt.innerText = text;
        }

        // å•Ÿå‹•åˆå§‹åŒ–
        init();
    </script>
</body>
</html>