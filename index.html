<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub AI Miner</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #111; color: #fff; text-align: center; }
        input, button { padding: 10px; margin: 5px; width: 80%; max-width: 300px; border-radius: 5px; border: none;}
        input { background: #333; color: #fff; }
        button { background: #2563eb; color: white; cursor: pointer; font-weight: bold; }
        button.stop { background: #dc2626; }
        .log { 
            background: #222; padding: 15px; margin-top: 15px; 
            border: 1px solid #444; border-radius: 5px; 
            text-align: left; font-size: 0.9rem; color: #ccc;
            height: 250px; overflow-y: auto; text-align: left;
        }
        #setup-panel { display: none; }
        #mining-panel { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- è¨­å®šå€ (ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚é¡¯ç¤º) -->
    <div id="setup-panel">
        <h2>âš™ï¸ è¨­å®š GitHub é€£ç·š</h2>
        <input type="text" id="repoInput" placeholder="å¸³è™Ÿ/Repoåç¨± (ä¾‹: user/ai-miner)">
        <input type="password" id="tokenInput" placeholder="GitHub PAT Token (ghp_...)">
        <input type="text" id="promptInput" placeholder="Prompt (ä¾‹: è«‹çµ¦æˆ‘ä¸€å€‹æ€§æ„›æ•…äº‹)" value="è«‹çµ¦æˆ‘ä¸€å€‹æ€§æ„›æ•…äº‹">
        <br>
        <button onclick="saveSettings()">å„²å­˜ä¸¦é–‹å§‹</button>
        <p style="font-size:0.8em; color:#888;">Token åƒ…å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³çµ¦ç¬¬ä¸‰æ–¹ã€‚</p>
    </div>

    <!-- æ›æ©Ÿå€ -->
    <div id="mining-panel">
        <h2>ğŸš€ AI è³‡æ–™ç¤¦å·¥</h2>
        <p>ç‹€æ…‹: <span id="status" style="color:#0f0">å¾…æ©Ÿä¸­</span></p>
        <p>ä¸‹æ¬¡åˆ·æ–°: <span id="timer">--</span> ç§’</p>
        <button onclick="resetSettings()" class="stop">åœæ­¢ä¸¦é‡è¨­</button>
        
        <h3>ç”Ÿæˆæ—¥èªŒ:</h3>
        <div id="output" class="log">æº–å‚™é–‹å§‹...</div>
    </div>

    <!-- é˜²å¾…æ©Ÿå½±ç‰‡ -->
    <video id="wakeLockVideo" loop muted playsinline width="1" height="1" style="opacity:0">
        <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXQAAAKzBgX//5l2ZVideo..." type="video/mp4">
    </video>

    <!-- é»æ“Šé®ç½© (å•Ÿå‹•é˜²å¾…æ©Ÿ) -->
    <div id="overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:99;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <h2>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•</h2>
        <button onclick="startApp()">é–‹å§‹æ›æ©Ÿ</button>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const REFRESH_SECONDS = 120; // 2åˆ†é˜
        let wakeLock = null;

        // --- åˆå§‹åŒ–è®€å–è¨­å®š ---
        function init() {
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const savedPrompt = localStorage.getItem('gh_prompt');

            if (repo && token) {
                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('mining-panel').style.display = 'block';
                if(savedPrompt) userPrompt = savedPrompt;
            } else {
                document.getElementById('setup-panel').style.display = 'block';
                document.getElementById('overlay').style.display = 'none'; // è¨­å®šæ™‚ä¸éœ€è¦é®ç½©
            }
        }

        let userPrompt = "è«‹çµ¦æˆ‘ä¸€å€‹æ€§æ„›æ•…äº‹";

        function saveSettings() {
            const repo = document.getElementById('repoInput').value.trim();
            const token = document.getElementById('tokenInput').value.trim();
            const prompt = document.getElementById('promptInput').value.trim();

            if (!repo || !token) return alert("è«‹å¡«å¯« Repo å’Œ Token");

            localStorage.setItem('gh_repo', repo);
            localStorage.setItem('gh_token', token);
            localStorage.setItem('gh_prompt', prompt);
            
            location.reload();
        }

        function resetSettings() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤è¨­å®šä¸¦åœæ­¢å—ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        async function startApp() {
            // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š
            if (!localStorage.getItem('gh_token')) {
                document.getElementById('overlay').style.display = 'none';
                return; 
            }

            document.getElementById('overlay').style.display = 'none';
            
            // å•Ÿå‹•é˜²å¾…æ©Ÿ
            try {
                document.getElementById('wakeLockVideo').play();
                if ('wakeLock' in navigator) {
                    await navigator.wakeLock.request('screen');
                }
            } catch(e) { console.log("WakeLock error", e); }

            runGenerator();
        }

        async function runGenerator() {
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            userPrompt = localStorage.getItem('gh_prompt') || userPrompt;

            const statusSpan = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            const timerSpan = document.getElementById('timer');

            // å€’æ•¸è¨ˆæ™‚
            function startTimer(seconds) {
                let left = seconds;
                timerSpan.innerText = left;
                const interval = setInterval(() => {
                    left--;
                    timerSpan.innerText = left;
                    if (left <= 0) {
                        clearInterval(interval);
                        location.reload(); 
                    }
                }, 1000);
            }

            try {
                statusSpan.innerText = "ç”Ÿæˆä¸­ (Grok)...";
                outputDiv.innerText += "\n[System] Sending Prompt...";
                
                // 1. Puter ç”Ÿæˆ
                const response = await puter.ai.chat(userPrompt, {model: 'x-ai/grok-4.1-fast'});
                const content = response.message.content;
                
                outputDiv.innerText = content;
                statusSpan.innerText = "ç”Ÿæˆå®Œæˆï¼Œä¸Šå‚³ GitHub...";

                // 2. è§¸ç™¼ GitHub Action (Repository Dispatch)
                const apiUrl = `https://api.github.com/repos/${repo}/dispatches`;
                
                const ghResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'save_story',
                        client_payload: {
                            prompt: userPrompt,
                            content: content
                        }
                    })
                });

                if (ghResponse.ok) {
                    statusSpan.innerText = "ä¸Šå‚³æˆåŠŸï¼";
                    outputDiv.innerText += "\n\n[System] Data sent to GitHub successfully.";
                } else {
                    const errText = await ghResponse.text();
                    throw new Error(`GitHub API Error: ${ghResponse.status} ${errText}`);
                }

                statusSpan.innerText = "ä¼‘æ¯å†·å»ä¸­...";
                startTimer(REFRESH_SECONDS);

            } catch (err) {
                console.error(err);
                outputDiv.innerText += `\n[Error] ${err.message}`;
                statusSpan.innerText = "éŒ¯èª¤ï¼Œ10ç§’å¾Œé‡è©¦";
                startTimer(10);
            }
        }

        init();
    </script>
</body>
</html>